@page "/"
@using Pianoteq.Client.Models
@using Pianoteq.Pwa.Services
@using Microsoft.JSInterop
@inject PianoteqClient Client
@inject FavoritesService Favorites
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>Pianoteq</PageTitle>

<style>
    body {
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
    
    .full-height {
        height: 100vh;
        display: flex;
        flex-direction: column;
    }
    
    .preset-button {
        width: 100%;
        text-align: left;
        justify-content: flex-start;
    }
    
    .preset-scroll {
        max-height: 100%;
        overflow-y: auto;
    }
</style>

<div class="full-height">
    
    @if (_loading)
    {
        <MudPaper Elevation="4" Square="true" Style="padding: 48px; flex: 1; display: flex; align-items: center; justify-content: center;">
            <MudStack AlignItems="AlignItems.Center" Spacing="4">
                <MudProgressCircular Size="Size.Large" Indeterminate="true" />
                <MudText Typo="Typo.h6">Loading presets...</MudText>
            </MudStack>
        </MudPaper>
    }
    else
    {
        @* Navigation Rows *@
        <MudPaper Elevation="4" Square="true" Style="padding: 16px;">
            <MudStack Spacing="2">
                @* Row 1: Favorite Navigation *@
                <MudGrid Justify="Justify.Center">
                    <MudItem xs="2" Style="text-align: center;">
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                                       Color="Color.Warning"
                                       Size="Size.Medium"
                                       Variant="Variant.Outlined"
                                       OnClick="PreviousFavorite"
                                       Disabled="@(!_favoritePresets.Any())" />
                    </MudItem>
                    <MudItem xs="8" Style="text-align: center;">
                        <MudIconButton Icon="@(_isFavorite ? Icons.Material.Filled.Star : Icons.Material.Outlined.StarBorder)"
                                       Color="Color.Warning"
                                       Size="Size.Large"
                                       Variant="@(_isFavorite ? Variant.Filled : Variant.Outlined)"
                                       OnClick="ToggleFavorite" />
                    </MudItem>
                    <MudItem xs="2" Style="text-align: center;">
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowForward"
                                       Color="Color.Warning"
                                       Size="Size.Medium"
                                       Variant="Variant.Outlined"
                                       OnClick="NextFavorite"
                                       Disabled="@(!_favoritePresets.Any())" />
                    </MudItem>
                </MudGrid>

                @* Row 2: Instrument Navigation *@
                <MudGrid Justify="Justify.Center">
                    <MudItem xs="2" Style="text-align: center;">
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                                       Color="Color.Primary"
                                       Size="Size.Medium"
                                       OnClick="PreviousInstrument" />
                    </MudItem>
                    <MudItem xs="8" Style="text-align: center;">
                        <MudText Typo="Typo.h6">@_currentPreset?.Instrument</MudText>
                    </MudItem>
                    <MudItem xs="2" Style="text-align: center;">
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowForward"
                                       Color="Color.Primary"
                                       Size="Size.Medium"
                                       OnClick="NextInstrument" />
                    </MudItem>
                </MudGrid>

                @* Row 3: Preset Navigation *@
                <MudGrid Justify="Justify.Center">
                    <MudItem xs="2" Style="text-align: center;">
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                                       Color="Color.Secondary"
                                       Size="Size.Medium"
                                       OnClick="PreviousPreset" />
                    </MudItem>
                    <MudItem xs="8" Style="text-align: center;">
                        <MudText Typo="Typo.h5">@_currentPreset?.Name</MudText>
                    </MudItem>
                    <MudItem xs="2" Style="text-align: center;">
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowForward"
                                       Color="Color.Secondary"
                                       Size="Size.Medium"
                                       OnClick="NextPreset" />
                    </MudItem>
                </MudGrid>
            </MudStack>
        </MudPaper>

        @* Middle: Preset Lists *@
        <div style="flex: 1; overflow: hidden; padding: 16px;">
            <MudGrid Style="height: 100%;">
                @* Left: Favorites *@
                <MudItem xs="6" Style="height: 100%;">
                    <MudPaper Elevation="2" Style="height: 100%; display: flex; flex-direction: column; padding: 16px;">
                        <MudText Typo="Typo.h6" Style="margin-bottom: 8px;">Favorites</MudText>
                        <div class="preset-scroll">
                            @if (!_favoritePresets.Any())
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">No favorites yet. Click the star to add!</MudText>
                            }
                            else
                            {
                                <MudStack Spacing="2">
                                    @foreach (var preset in _favoritePresets)
                                    {
                                        <MudButton Class="preset-button"
                                                   Variant="@(preset.Name == _currentPreset?.Name ? Variant.Filled : Variant.Outlined)"
                                                   Color="@(preset.Name == _currentPreset?.Name ? Color.Primary : Color.Default)"
                                                   Size="Size.Large"
                                                   StartIcon="@Icons.Material.Filled.Star"
                                                   OnClick="@(() => LoadPresetAsync(preset))">
                                            @preset.Name
                                        </MudButton>
                                    }
                                </MudStack>
                            }
                        </div>
                    </MudPaper>
                </MudItem>

                @* Right: All Presets *@
                <MudItem xs="6" Style="height: 100%;">
                    <MudPaper Elevation="2" Style="height: 100%; display: flex; flex-direction: column; padding: 16px;">
                        <MudText Typo="Typo.h6" Style="margin-bottom: 8px;">All Presets (@_filteredPresets.Count)</MudText>
                        <div class="preset-scroll" id="preset-scroll-container">
                            <MudStack Spacing="1">
                                @foreach (var preset in _filteredPresets)
                                {
                                    var isFav = Favorites.IsFavorite(preset.Name);
                                    var isLicensed = preset.LicenseStatus == "ok";
                                    var isSelected = preset.Name == _currentPreset?.Name;
                                    <MudButton Class="preset-button"
                                               id="@(isSelected ? "selected-preset" : "")"
                                               Variant="@(isSelected ? Variant.Filled : Variant.Outlined)"
                                               Color="@(isSelected ? Color.Primary : Color.Default)"
                                               Size="Size.Small"
                                               EndIcon="@(isFav ? Icons.Material.Filled.Star : (isLicensed ? "" : Icons.Material.Filled.Lock))"
                                               OnClick="@(() => LoadPresetAsync(preset))">
                                        @preset.Name
                                    </MudButton>
                                }
                            </MudStack>
                        </div>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </div>

        @* Bottom: Condition Slider + Settings *@
        <MudPaper Elevation="4" Square="true" Style="padding: 24px;">
            <MudGrid>
                @* Slider *@
                <MudItem xs="9">
                    <MudStack Spacing="2">
                        <MudGrid Justify="Justify.SpaceBetween">
                            <MudItem>
                                <MudText Typo="Typo.h6">Condition</MudText>
                            </MudItem>
                            <MudItem>
                                <MudChip T="string" Color="@GetConditionColor()" Size="Size.Medium">
                                    @GetConditionLabel()
                                </MudChip>
                            </MudItem>
                        </MudGrid>
                        
                        <MudSlider T="double"
                                   Value="_condition"
                                   ValueChanged="@((double val) => OnConditionChanged(val))"
                                   Min="0.0"
                                   Max="1.0"
                                   Step="0.01"
                                   Color="Color.Primary"
                                   Size="Size.Large" />
                        
                        <MudGrid>
                            <MudItem xs="4">
                                <MudText Typo="Typo.caption" Align="Align.Left">New</MudText>
                            </MudItem>
                            <MudItem xs="4">
                                <MudText Typo="Typo.caption" Align="Align.Center">Used</MudText>
                            </MudItem>
                            <MudItem xs="4">
                                <MudText Typo="Typo.caption" Align="Align.Right">Worn</MudText>
                            </MudItem>
                        </MudGrid>
                    </MudStack>
                </MudItem>

                @* Settings *@
                <MudItem xs="3" Style="display: flex; align-items: center; justify-content: flex-end;">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Settings</MudText>
                        <MudChip T="string"
                                 Icon="@(_licensedOnly ? Icons.Material.Filled.CheckCircle : Icons.Material.Outlined.Circle)"
                                 Color="@(_licensedOnly ? Color.Success : Color.Default)"
                                 Variant="@(_licensedOnly ? Variant.Filled : Variant.Outlined)"
                                 Size="Size.Small"
                                 OnClick="ToggleLicensedOnly">
                            Licensed Only
                        </MudChip>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudPaper>
    }

</div>

@code {
    private List<PresetInfo> _allPresets = new();
    private List<PresetInfo> _filteredPresets = new();
    private List<PresetInfo> _favoritePresets = new();
    private PresetInfo? _currentPreset;
    private double _condition = 0.5;
    private bool _loading = true;
    private bool _licensedOnly = true;
    private bool _isFavorite = false;
    private System.Threading.Timer? _debounceTimer;

    protected override async Task OnInitializedAsync()
    {
        await Favorites.InitializeAsync();
        await LoadAllPresetsAsync();
    }

    private async Task LoadAllPresetsAsync()
    {
        _loading = true;
        StateHasChanged();
        
        try
        {
            // Load all presets
            _allPresets = await Client.GetListOfPresetsAsync();
            
            // Get current preset
            var info = await Client.GetInfoAsync();
            _currentPreset = _allPresets.FirstOrDefault(p => p.Name == info.CurrentPreset?.Name);
            if (_currentPreset == null && _allPresets.Any())
            {
                _currentPreset = _allPresets.First();
            }
            
            // Load condition
            await LoadConditionAsync();
            
            // Update filtered lists
            UpdateFilteredLists();
            
            _isFavorite = _currentPreset != null && Favorites.IsFavorite(_currentPreset.Name);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading presets: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
            await ScrollToSelectedPreset();
        }
    }

    private void UpdateFilteredLists()
    {
        // Filter presets based on licensed setting
        _filteredPresets = _licensedOnly
            ? _allPresets.Where(p => p.LicenseStatus == "ok").ToList()
            : _allPresets;
        
        // Get favorite presets
        var favoriteNames = Favorites.GetAllFavorites();
        _favoritePresets = _allPresets.Where(p => favoriteNames.Contains(p.Name)).ToList();
    }

    private async Task LoadConditionAsync()
    {
        try
        {
            var parameters = await Client.GetParametersAsync();
            var conditionParam = parameters.FirstOrDefault(p =>
                p.Id.Contains("Condition", StringComparison.OrdinalIgnoreCase) ||
                p.Name.Contains("Condition", StringComparison.OrdinalIgnoreCase));
            
            if (conditionParam != null)
            {
                _condition = conditionParam.NormalizedValue;
            }
        }
        catch
        {
            // Ignore errors loading condition
        }
    }

    private async Task LoadPresetAsync(PresetInfo preset)
    {
        try
        {
            await Client.LoadPresetAsync(preset.Name);
            _currentPreset = preset;
            _isFavorite = Favorites.IsFavorite(preset.Name);
            await LoadConditionAsync();
            StateHasChanged();
            await ScrollToSelectedPreset();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading preset: {ex.Message}", Severity.Error);
        }
    }

    private async Task ScrollToSelectedPreset()
    {
        try
        {
            await Task.Delay(50); // Small delay to ensure DOM is updated
            await JS.InvokeVoidAsync("eval", @"
                const selected = document.getElementById('selected-preset');
                const container = document.getElementById('preset-scroll-container');
                if (selected && container) {
                    const containerRect = container.getBoundingClientRect();
                    const selectedRect = selected.getBoundingClientRect();
                    const scrollTop = selected.offsetTop - container.offsetTop - (containerRect.height / 2) + (selectedRect.height / 2);
                    container.scrollTo({ top: scrollTop, behavior: 'smooth' });
                }
            ");
        }
        catch
        {
            // Ignore scroll errors
        }
    }

    private async Task ToggleFavorite()
    {
        if (_currentPreset == null) return;
        
        await Favorites.ToggleFavoriteAsync(_currentPreset.Name);
        _isFavorite = Favorites.IsFavorite(_currentPreset.Name);
        UpdateFilteredLists();
        StateHasChanged();
    }

    private void ToggleLicensedOnly()
    {
        _licensedOnly = !_licensedOnly;
        UpdateFilteredLists();
        StateHasChanged();
    }

    private async Task NextPreset()
    {
        var presets = _filteredPresets;
        if (!presets.Any() || _currentPreset == null) return;
        
        var currentIndex = presets.FindIndex(p => p.Name == _currentPreset.Name);
        var nextIndex = (currentIndex + 1) % presets.Count;
        await LoadPresetAsync(presets[nextIndex]);
    }

    private async Task PreviousPreset()
    {
        var presets = _filteredPresets;
        if (!presets.Any() || _currentPreset == null) return;
        
        var currentIndex = presets.FindIndex(p => p.Name == _currentPreset.Name);
        var prevIndex = currentIndex <= 0 ? presets.Count - 1 : currentIndex - 1;
        await LoadPresetAsync(presets[prevIndex]);
    }

    private async Task NextInstrument()
    {
        if (_currentPreset == null) return;
        
        var instruments = _filteredPresets.Select(p => p.Instrument).Distinct().Where(i => !string.IsNullOrEmpty(i)).ToList();
        var currentInstrument = _currentPreset.Instrument;
        var currentIndex = instruments.IndexOf(currentInstrument);
        var nextIndex = (currentIndex + 1) % instruments.Count;
        var nextInstrument = instruments[nextIndex];
        
        var firstPreset = _filteredPresets.FirstOrDefault(p => p.Instrument == nextInstrument);
        if (firstPreset != null)
        {
            await LoadPresetAsync(firstPreset);
        }
    }

    private async Task PreviousInstrument()
    {
        if (_currentPreset == null) return;
        
        var instruments = _filteredPresets.Select(p => p.Instrument).Distinct().Where(i => !string.IsNullOrEmpty(i)).ToList();
        var currentInstrument = _currentPreset.Instrument;
        var currentIndex = instruments.IndexOf(currentInstrument);
        var prevIndex = currentIndex <= 0 ? instruments.Count - 1 : currentIndex - 1;
        var prevInstrument = instruments[prevIndex];
        
        var firstPreset = _filteredPresets.FirstOrDefault(p => p.Instrument == prevInstrument);
        if (firstPreset != null)
        {
            await LoadPresetAsync(firstPreset);
        }
    }

    private async Task NextFavorite()
    {
        if (!_favoritePresets.Any() || _currentPreset == null) return;
        
        var currentIndex = _favoritePresets.FindIndex(p => p.Name == _currentPreset.Name);
        var nextIndex = currentIndex < 0 ? 0 : (currentIndex + 1) % _favoritePresets.Count;
        await LoadPresetAsync(_favoritePresets[nextIndex]);
    }

    private async Task PreviousFavorite()
    {
        if (!_favoritePresets.Any() || _currentPreset == null) return;
        
        var currentIndex = _favoritePresets.FindIndex(p => p.Name == _currentPreset.Name);
        var prevIndex = currentIndex <= 0 ? _favoritePresets.Count - 1 : currentIndex - 1;
        await LoadPresetAsync(_favoritePresets[prevIndex]);
    }

    private void OnConditionChanged(double value)
    {
        _condition = value;
        StateHasChanged();
        
        _debounceTimer?.Dispose();
        _debounceTimer = new System.Threading.Timer(async _ =>
        {
            try
            {
                var parameters = await Client.GetParametersAsync();
                var conditionParam = parameters.FirstOrDefault(p =>
                    p.Id.Contains("Condition", StringComparison.OrdinalIgnoreCase) ||
                    p.Name.Contains("Condition", StringComparison.OrdinalIgnoreCase));
                
                if (conditionParam != null)
                {
                    var updatedParam = new ParameterInfo
                    {
                        Id = conditionParam.Id,
                        NormalizedValue = _condition
                    };
                    
                    await Client.SetParametersAsync(new List<ParameterInfo> { updatedParam });
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error updating condition: {ex.Message}");
            }
        }, null, 300, Timeout.Infinite);
    }

    private string GetConditionLabel()
    {
        if (_condition < 0.3) return "New Piano";
        if (_condition < 0.7) return "Used Piano";
        return "Worn Piano";
    }

    private Color GetConditionColor()
    {
        if (_condition < 0.3) return Color.Success;
        if (_condition < 0.7) return Color.Warning;
        return Color.Error;
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}
